<a id="en"></a>
# WRTExpand 
---
An easy to use batch auto expend root storage for Firendlyelec NanoPi and compatible Arm devices
---
[点击跳转中文版](#cn)
---
Automated root partition and filesystem expansion script for **OpenWrt/ImmortalWrt** on ARM devices (optimized for **NanoPi R3S**, Other NanoPi devices should also be compatible.).

---

## Features
* **Automated Dependency Installation**: Installs `fdisk`, `e2fsprogs`, `resize2fs`, `losetup`, and `tune2fs`.
* **Partition Resizing**: Safely redefines the partition table to use total disk capacity.
* **Online-Bypass Expansion**: Uses `losetup` to handle filesystems that refuse online resizing.
* **Reserved Space Optimization**: Sets reserved blocks to 1% to increase usable capacity.

---

## Usage (One-Click)

Execute the following command in your SSH terminal:

```bash
wget -qO- https://raw.githubusercontent.com/MrTangLuyao/wrtexpend/refs/heads/main/expend.sh | sh
```
**If the expansion is successful but storage usage is almost full run:**
```bash
sync
reboot
opkg update
opkg install tune2fs
tune2fs -m 1 /dev/mmcblk1p2
```
**Optional: Clean up**
```bash
rm -f /usr/sbin/r3s-expand-stage2.sh
rm -rf /etc/r3s-expand/
rm -f /root/ptable_backup_*.img
```
/root/ptable_backup_YYYYMMDD_HHMMSS.img
Generated by backup_ptable. Backs up the partition table in the first 2MB of the disk. Retained permanently; no automatic 

---

## Prerequisites
* **Device**: FriendlyElec NanoPi R3S (Target disk: `/dev/mmcblk1`).
* **Firmware**: ImmortalWrt / OpenWrt (Ext4 filesystem).
* **Network**: Active internet connection for `opkg` downloads.

---

## Warning
**Use at your own risk.** This script modifies partition tables. Back up critical data before proceeding.

---
<a id="cn"></a>
[Switch to English](#en)
# 中文说明 (Chinese Version)

适用于 ARM 设备（针对 **NanoPi R3S** 优化, 其他友善科技 NanoPi 系列也应该适用）的 **OpenWrt/ImmortalWrt** 根分区与文件系统自动化扩容脚本。

---

## 使用方法 (一键脚本)

在 SSH 终端中执行以下命令：

```bash
wget -qO- https://raw.githubusercontent.com/MrTangLuyao/wrtexpend/refs/heads/main/expend.sh | sh
```
**如果扩容成功但空间占用却异常的高,请执行:**
```bash
sync
reboot
opkg update
opkg install tune2fs
tune2fs -m 1 /dev/mmcblk1p2
```
**可选：清理残留**
```bash
rm -f /usr/sbin/r3s-expand-stage2.sh
rm -rf /etc/r3s-expand/
rm -f /root/ptable_backup_*.img
```
/root/ptable_backup_YYYYMMDD_HHMMSS.img
由backup_ptable生成，备份磁盘前2MB分区表，永久保留，不会自动清理。

---

## 工作原理
1. **环境初始化**: 通过 `opkg` 检查并安装缺少的工具。
2. **扇区检测**: 自动获取当前根分区的起始扇区偏移量。
3. **更新分区表**: 删除旧分区定义并基于原起始扇区重建分区，使其覆盖磁盘末尾。
4. **文件系统扩容**:
   - 将分区映射至回环设备（Loop Device）。
   - 执行强制文件系统检查（`e2fsck`）。
   - 执行 `resize2fs` 完成逻辑扩容。
5. **完成收尾**: 调整预留空间比例并自动重启系统。

---

## 前提条件
* **硬件**: 友善电子 NanoPi R3S（目标磁盘识别为 `/dev/mmcblk1`）。
* **固件**: ImmortalWrt / OpenWrt (Ext4 格式)。
* **网络**: 需要互联网连接以获取 `opkg` 软件包供应。

---

## 警告
**风险自担。** 修改分区表属于高风险操作。在执行脚本前，请务必备份您的重要配置文件。
